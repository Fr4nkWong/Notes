---
title: 浏览器机制笔记
birth: 2018-05-01
category:
- front-end
---

**任务在浏览器中的运作** 
以Chrome为例子，浏览器是多进程的...

- Browser进程：浏览器<u>有且只有一个</u>的主进程(负责协调、控制)；
  - 负责浏览器界面显示，与用户交互；
  - 负责各个页面(Tab)的管理，创建和销毁；
  - 将Renderer进程得到的内存中的位图`Bitmap`，绘制到用户界面上；
  - 网络资源的管理、下载等；
- GPU进程：最多就一个，用于3D绘制；
- Render进程：又称为**浏览器内核**，其内部是多线程的；默认每个Tab页面一个进程(进程内有自己的多线程)，互不影响；主要作用为页面渲染、脚本执行、事件处理；
  - GUI渲染线程：
    - what: 负责渲染浏览器界面；
    - how: 解析HTML/CSS，构建DOM树/RenderObject树，布局和绘制(如`Repaint`和`Reflow`)；
    - **GUI渲染线程与JS引擎线程互斥！**当JS引擎执行时GUI线程会被挂起（相当于被冻结了），GUI更新会被保存在一个队列`macrotask`中等到JS引擎空闲时立即被执行，所以JS脚本加载过久，会导致浏览器渲染不连贯，甚至阻塞；
  - JS引擎线程：
    - what: 又称为**JS内核**；负责解析、运行JS脚本；`V8引擎`
    - how: JS引擎一直等待着`任务队列`中任务的到来，然后加以处理，<u>一个Tab页（renderer进程）</u>中无论什么时候都<u>只有一个</u>JS引擎线程在处理JS脚本；
    - 创建WebWorker时，JS引擎向浏览器申请创建一个子线程(子线程由浏览器创建，受Browser进程控制且只属于某个Tab页面，不能操作DOM)；
  - 事件触发线程：
    - what: 用于控制事件循环；当JS引擎执行代码块(如触发SetTimeout、鼠标点击、AJAX异步请求等)，会将对应任务添加到事件触发线程中；
    - how: 当对应的事件符合触发条件被触发时，事件触发线程会把该事件添加到`待处理队列macrotask`的队尾，等待JS引擎进行处理；
  - 定时触发线程：
    - `setInterval()`与`setTimeout()`所在的线程；
    - 通过此线程来单独计时并触发定时（计时完毕后，添加到事件队列中，等待JS引擎空闲后执行）；
  - 异步http请求线程：
    - `XMLHttpRequest`在连接后通过浏览器新开一个线程请求；
    - 将检测到状态变更时，如果设置有回调函数，异步线程就产生状态变更事件，将这个回调再放入`事件队列macrotask`中，再由JavaScript引擎执行；
- 第三方插件进程：每种类型的插件对应一个进程，仅当使用该插件时才创建；